function verificarHash() {
  const hash = document.getElementById("hash").value.trim();
  if (!hash) {
    document.getElementById("erro").innerText = "Informe o hash.";
    return;
  }

  fetch(`${urlAPI}?acao=verificar&hash=${encodeURIComponent(hash)}`)
    .then(res => res.json())
    .then(json => {
      if (json.erro) {
        document.getElementById("erro").innerText = json.erro;
        return;
      }

      document.getElementById("login").style.display = "none";
      document.querySelector(".painel").style.display = "block";

      const dados = json.dados || json;

      if (!dados || dados.length === 0) {
        document.getElementById("painel").innerHTML = "<p style='color:red'>Nenhum dado retornado.</p>";
        return;
      }

      const colunas = Object.keys(dados[0]).filter(c => {
        const nome = c.trim().toLowerCase();
        return nome !== "nome" && nome !== "preço" && nome !== "volume" && nome !== "market cap";
      });

      const prioridade = [
        "símbolo",
        "ranking",
        "link",
        "pontuação on-chain",
        "pontuação balanceada",
        "pontuação anterior"
      ];

      const colunasOrdenadas = [
        ...colunas.filter(c => prioridade.includes(c.trim().toLowerCase())),
        ...colunas.filter(c => !prioridade.includes(c.trim().toLowerCase()))
      ];

      const dadosFormatados = dados.map(item =>
        colunasOrdenadas.map(campo =>
          campo.toLowerCase() === "link"
            ? `<a href="${item[campo]}" target="_blank">Ver</a>`
            : item[campo]
        )
      );

      $('#painel').DataTable({
        data: dadosFormatados,
        columns: colunasOrdenadas.map(c => {
          let titulo = c.trim();
          const nome = titulo.toLowerCase();
          if (nome === "pontuação anterior") titulo = "P Anterior";
          else if (nome === "pontuação balanceada") titulo = "P Balanceada";
          else if (nome === "pontuação on-chain") titulo = "P On-Chain";
          else if (nome === "tendência consolidada") titulo = "T Consolidada";
          else if (nome === "símbolo") titulo = "Símbolo";
          else if (nome === "ranking") titulo = "Ranking";
          else if (nome === "link") titulo = "Link";
          return { title: titulo };
        }),
        scrollX: true,
        paging: false,
        searching: false,
        info: false,
        createdRow: function(row, data) {
          const idx = colunasOrdenadas.findIndex(c => c.trim().toLowerCase() === "pontuação balanceada");
          if (idx >= 0) {
            const score = parseFloat(data[idx]);
            if (score >= 600) $(row).addClass('azul');
            else if (score >= 500) $(row).addClass('verde');
            else if (score >= 300) $(row).addClass('amarelo');
            else if (score >= 250) $(row).addClass('rosa');
          }
        },
        language: {
          url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json"
        }
      });
    })
    .catch(() => {
      document.getElementById("erro").innerText = "Erro ao verificar hash.";
    });
}
