<script>
const urlAPI = "https://script.google.com/macros/s/AKfycbxvWUfo_Fzlm6b2ZP20-aK5AEeF4b1phehQmvUBsWoja9aALWuAq8aiK0LYOQEb93MF/exec";

function verificarLogin() {
  const email = document.getElementById("email").value.trim();
  const codigo = document.getElementById("codigo").value.trim();
  if (!email || !codigo) {
    document.getElementById("erro").innerText = "Preencha e-mail e código.";
    return;
  }

  fetch(`${urlAPI}?email=${email}&codigo=${codigo}`)
    .then(res => res.json())
    .then(json => {
      if (json.erro) {
        document.getElementById("erro").innerText = json.erro;
        return;
      }

      document.getElementById("login").style.display = "none";
      document.querySelector(".painel").style.display = "block";

      const dados = json.dados || json;

      // Remove apenas a coluna Volume
      const colunas = Object.keys(dados[0] || {}).filter(c => c !== "Volume");

      const dadosFormatados = dados.map(item =>
        colunas.map(campo =>
          campo === "Link" ? `<a href="${item[campo]}" target="_blank">Ver</a>` : item[campo]
        )
      );

      $('#painel').DataTable({
        data: dadosFormatados,
        columns: colunas.map(c => ({ title: c })),
        scrollX: true,
        paging: false,
        searching: false,
        info: false,
        createdRow: function(row, data) {
          const idx = colunas.indexOf("Pontuação Balanceada");
          if (idx >= 0) {
            const score = parseFloat(data[idx]);
            if (score >= 600) $(row).addClass('azul');
            else if (score >= 500) $(row).addClass('verde');
            else if (score >= 300) $(row).addClass('amarelo');
            else if (score >= 250) $(row).addClass('rosa');
          }
        },
        language: {
          url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json"
        }
      });
    })
    .catch(() => {
      document.getElementById("erro").innerText = "Erro ao carregar dados.";
    });
}
</script>
