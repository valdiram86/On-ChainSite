function doGet(e) {
  const acao = (e.parameter.acao || "").toLowerCase();
  const email = (e.parameter.email || "").toLowerCase().trim();
  const codigo = (e.parameter.codigo || "").trim();

  const planilha = SpreadsheetApp.getActiveSpreadsheet();
  const abaSenhas = planilha.getSheetByName("Senhas");
  const abaCodigos = planilha.getSheetByName("Codigos") || planilha.insertSheet("Codigos");

  if (!abaSenhas) {
    return respostaJson({ erro: "Aba 'Senhas' não encontrada." });
  }

  const autorizados = abaSenhas.getRange(2, 1, abaSenhas.getLastRow() - 1).getValues().flat().map(s => s.toLowerCase());
  if (!autorizados.includes(email)) {
    return respostaJson({ erro: "Acesso negado" });
  }

  if (acao === "enviar") {
    const novoCodigo = gerarCodigo();
    MailApp.sendEmail({
      to: email,
      subject: "Seu código de acesso – On-Chain SetValues",
      htmlBody: `Seu código de acesso é: <b>${novoCodigo}</b><br><br>Use-o para entrar no painel.`,
      name: "On-Chain SetValues",
      replyTo: EMAIL_REMETENTE
    });
    abaCodigos.appendRow([new Date(), email, novoCodigo]);
    return respostaJson({ status: "Código enviado com sucesso." });
  }

  if (acao === "verificar") {
    const linhas = abaCodigos.getRange(2, 1, abaCodigos.getLastRow() - 1, 3).getValues();
    const encontrado = linhas.reverse().find(l => l[1] === email && l[2] == codigo);
    if (encontrado) {
      return respostaJson({ status: "Acesso liberado" });
    } else {
      return respostaJson({ erro: "Código inválido ou expirado." });
    }
  }

  // Caso nenhuma ação, retorna os dados da planilha principal
  const abaDados = planilha.getSheetByName("On-ChainSetValues");
  if (!abaDados) return respostaJson({ erro: "Aba de dados não encontrada." });

  const dados = abaDados.getDataRange().getValues();
  const cab = dados[0];
  const json = [];

  for (let i = 1; i < dados.length; i++) {
    const obj = {};
    for (let j = 0; j < cab.length; j++) {
      obj[cab[j]] = dados[i][j];
    }

    const score = parseFloat(obj["Pontuação Balanceada"]);
    obj["cor"] =
      score >= 600 ? "azul" :
      score >= 500 ? "verde" :
      score >= 300 ? "amarelo" :
      score >= 250 ? "rosa" : "";

    json.push(obj);
  }

  return respostaJson(json);
}
