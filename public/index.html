const CMC_API_KEY = '3f2fc20e-1d90-4dbc-86d6-4d1e30ed5024';

function atualizarTudo() {
  const dados = obterDadosCMC();
  preencherPlanilha(dados);
  aplicarCores();
  salvarHistorico();
}

function obterDadosCMC() {
  const url = 'https://pro-api.coinmarketcap.com/v1/cryptocurrency/listings/latest?limit=1700&start=1';
  const options = {
    headers: { 'X-CMC_PRO_API_KEY': CMC_API_KEY },
    muteHttpExceptions: true
  };
  const resposta = UrlFetchApp.fetch(url, options);
  const json = JSON.parse(resposta.getContentText());

  const stable = ['USDT', 'USDC', 'BUSD', 'TUSD', 'DAI', 'USDP', 'USDD', 'GUSD', 'LUSD', 'OUSD', 'SUSD', 'FEI', 'HUSD', 'FRAX', 'EUROC', 'USDN', 'ALUSD'];
  return json.data.filter(c => {
    const simbolo = c.symbol.toUpperCase();
    const nome = c.name.toLowerCase();
    return !stable.includes(simbolo) && !nome.includes('usd') && !nome.includes('stable') && !nome.includes('dollar');
  });
}

function calcularPontuacaoBruta(c) {
  const v7 = c.quote.USD.percent_change_7d || 0;
  const v30 = c.quote.USD.percent_change_30d || 0;
  const v90 = c.quote.USD.percent_change_90d || 0;
  return Math.round(Math.max(0, Math.min(700, 100 + v7 * 2 + v30 + v90 * 0.5)));
}

function aplicarBalanceamento(score, rank) {
  let mult = 1;
  if (rank <= 150) mult = 0.3;
  else if (rank <= 300) mult = 0.5;
  else if (rank <= 700) mult = 0.8;
  return Math.round(score * mult);
}

function preencherPlanilha(dados) {
  const aba = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("On-ChainSetValues");
  aba.clearContents();
  aba.setFrozenRows(1);
  aba.setFrozenColumns(1);

  const headers = [
    "Rank", "Nome", "Símbolo", "Preço", "Volume", "Market Cap",
    "Pontuação On-Chain", "Link", "Pontuação Anterior", "Variação",
    "Pontuação Balanceada", "Top 3D", "Top 7D", "Top 15D", "Top 30D", "Top 50D", "Tendência Consolidada"
  ];
  aba.getRange(1, 1, 1, headers.length).setValues([headers]);

  const linhas = dados.map(c => {
    const rank = c.cmc_rank;
    const preco = c.quote.USD.price;
    const volume = c.quote.USD.volume_24h;
    const marketcap = c.quote.USD.market_cap;
    const nome = c.name;
    const simbolo = c.symbol;
    const link = `https://coinmarketcap.com/currencies/${c.slug}`;
    const score = calcularPontuacaoBruta(c);
    const balanceado = aplicarBalanceamento(score, rank);
    return [rank, nome, simbolo, preco, volume, marketcap, score, link, "", "", balanceado, "", "", "", "", "", ""];
  });

  aba.getRange(2, 1, linhas.length, headers.length).setValues(linhas);
}

function aplicarCores() {
  const aba = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("On-ChainSetValues");
  const ult = aba.getLastRow();

  const valores = aba.getRange(2, 11, ult - 1).getValues();
  const cores = valores.map(([v]) => {
    if (v >= 600) return ['#3399ff'];
    if (v >= 500) return ['#00ff00'];
    if (v >= 300) return ['#ffff00'];
    if (v >= 250) return ['#ff00ff'];
    return ['white'];
  });
  aba.getRange(2, 11, ult - 1).setBackgrounds(cores);
}

function salvarHistorico() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const origem = ss.getSheetByName("On-ChainSetValues");
  const destino = ss.getSheetByName("Historico") || ss.insertSheet("Historico");

  const ultimaLinha = origem.getLastRow();
  const ultimaColuna = origem.getLastColumn();
  if (ultimaLinha <= 1) return;

  const dados = origem.getRange(2, 1, ultimaLinha - 1, ultimaColuna).getValues();
  destino.getRange(destino.getLastRow() + 1, 1, dados.length, ultimaColuna).setValues(dados);
}

// === API de Verificação de Acesso ===
function doGet(e) {
  const email = (e.parameter.email || "").toLowerCase().trim();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const aba = ss.getSheetByName("Senhas");

  if (!aba) {
    return ContentService.createTextOutput(JSON.stringify({ autorizado: false, erro: "Aba 'Senhas' não encontrada" }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const lista = aba.getRange(2, 1, aba.getLastRow() - 1, 1)
                  .getValues()
                  .flat()
                  .map(v => (v || "").toLowerCase().trim());

  if (!lista.includes(email)) {
    return ContentService.createTextOutput(JSON.stringify({ autorizado: false }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const dados = obterDadosComoArrayJson();

  return ContentService.createTextOutput(JSON.stringify({
    autorizado: true,
    dados: dados
  })).setMimeType(ContentService.MimeType.JSON);
}

function obterDadosComoArrayJson() {
  const aba = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("On-ChainSetValues");
  const valores = aba.getDataRange().getValues();
  const headers = valores[0];
  const linhas = valores.slice(1);

  return linhas.map(linha => {
    const item = {};
    headers.forEach((h, i) => item[h] = linha[i]);
    return item;
  });
}
