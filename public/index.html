<script>
const urlAPI = "https://script.google.com/macros/s/AKfycbxvWUfo_Fzlm6b2ZP20-aK5AEeF4b1phehQmvUBsWoja9aALWuAq8aiK0LYOQEb93MF/exec";

function verificarLogin() {
  const email = document.getElementById("email").value.trim();
  const codigo = document.getElementById("codigo").value.trim();
  if (!email || !codigo) {
    document.getElementById("erro").innerText = "Preencha e-mail e código.";
    return;
  }

  fetch(`${urlAPI}?email=${email}&codigo=${codigo}`)
    .then(res => res.json())
    .then(json => {
      if (json.erro) {
        document.getElementById("erro").innerText = json.erro;
        return;
      }

      document.getElementById("login").style.display = "none";
      document.querySelector(".painel").style.display = "block";

      const dados = json.dados || json;
      const colunasVisiveis = Object.keys(dados[0] || {}).filter(c => !["Nome", "Símbolo"].includes(c));
      const dadosFormatados = dados.map(item => {
        const combinada = `${item["Nome"]} (${item["Símbolo"]})`;
        return [combinada, ...colunasVisiveis.map(c => c === "Link" ? `<a href="${item[c]}" target="_blank">Ver</a>` : item[c])];
      });

      $('#painel').DataTable({
        data: dadosFormatados,
        columns: [{ title: "Nome (Símbolo)" }, ...colunasVisiveis.map(c => ({ title: c }))],
        scrollX: true,
        paging: false,
        searching: false,
        info: false,
        createdRow: function(row, data) {
          const index = colunasVisiveis.indexOf("Pontuação Balanceada") + 1;
          const score = parseFloat(data[index]);
          if (score >= 600) $(row).addClass('azul');
          else if (score >= 500) $(row).addClass('verde');
          else if (score >= 300) $(row).addClass('amarelo');
          else if (score >= 250) $(row).addClass('rosa');
        },
        language: {
          url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json"
        }
      });
    })
    .catch(() => {
      document.getElementById("erro").innerText = "Erro ao carregar dados.";
    });
}
</script>
